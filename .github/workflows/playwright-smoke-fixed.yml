name: Playwright Smoke Compare (fixed)

permissions:
  contents: read
  actions: write
  id-token: write

on:
  workflow_dispatch: {}
  push:
    branches: [ temp/disable-cdp, main ]

jobs:
  smoke-compare:
    name: Smoke Compare (fixed)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PLAYWRIGHT_CONFIG: Tests/playwright/playwright.config.cjs
      ENFORCE_CLIP: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache npm
        uses: actions/cache@v4
        id: cache-npm
        with:
          path: |
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json','**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: cache-playwright
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json','**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache-node-modules
        with:
          path: |
            node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json','**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Show cache status
        run: |
          echo "cache-playwright: ${{ steps.cache-playwright.outputs.cache-hit }}"
          echo "cache-node-modules: ${{ steps.cache-node-modules.outputs.cache-hit }}"
          echo "cache-npm: ${{ steps.cache-npm.outputs.cache-hit }}"

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          npm ci
        shell: bash

      - name: Skip npm ci when node_modules cache hit
        if: steps.cache-node-modules.outputs.cache-hit == 'true'
        run: |
          echo "node_modules cache hit; skipping npm ci"

      - name: Install Playwright and browsers (only on cache miss)
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: |
          npm explore playwright -- npm i >/dev/null || true
          # install browsers and native deps only when cache miss
          npx playwright install --with-deps
        shell: bash

      - name: Install NotoJP fonts (minimal)
        run: |
          # minimal font install only (avoid large extra packages)
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends fonts-noto-cjk fonts-noto-color-emoji || true
        shell: bash

      - name: Build
        run: npm run build

      - name: Serve dist and wait
        run: |
          npx http-server dist -p 1420 -c-1 &
          npx wait-on http://localhost:1420
        shell: bash

      - name: Health check (wait up to 20s)
        run: |
          for i in 1 2 3 4; do
            if curl -fsS http://localhost:1420/ >/dev/null 2>&1; then
              echo "service ready"
              exit 0
            fi
            sleep 5
          done
          echo "Service did not become ready within 20s" >&2
          exit 1
        shell: bash

      - name: Run smoke capture
        env:
          FORCE_SYSTEM_UI: '1'
          DISABLE_CDP: '1'
          URL: 'http://localhost:1420/'
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          mkdir -p builds/screenshots
          # start a minimal local ux-ping mock server so front-end pings succeed
          cat > ux_ping_server.py <<'PY'
    from http.server import BaseHTTPRequestHandler, HTTPServer
    import json

    class H(BaseHTTPRequestHandler):
      def _set_cors(self):
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')

      def _ok(self, payload=b'{"ok":true}'):
        self.send_response(200)
        self._set_cors()
        self.send_header('Content-Type','application/json')
        self.end_headers()
        try:
          self.wfile.write(payload)
        except BrokenPipeError:
          pass

      def do_OPTIONS(self):
        self.send_response(204)
        self._set_cors()
        self.end_headers()

      def do_GET(self):
        if self.path.startswith('/ux-ping'):
          self._ok()
        else:
          self.send_response(404); self.end_headers()

      def do_POST(self):
        if self.path.startswith('/ux-ping'):
          # consume body but ignore
          try:
            length = int(self.headers.get('Content-Length', 0))
            if length:
              self.rfile.read(length)
          except Exception:
            pass
          self._ok()
        else:
          self.send_response(404); self.end_headers()

    if __name__ == '__main__':
      server = HTTPServer(('127.0.0.1', 8765), H)
      print('ux-ping server listening on 127.0.0.1:8765')
      server.serve_forever()
    PY
          nohup python3 ux_ping_server.py > ux_ping.log 2>&1 &
          echo "started ux-ping server, pid=$(pgrep -f ux_ping_server.py || true)" || true
          sleep 1
          echo "--- ux_ping.log ---" ; tail -n +1 ux_ping.log || true
          echo "--- process list ---" ; ps -ef | grep ux_ping_server.py || true
          # run with a safety timeout to avoid long-running hangs (25m)
          timeout 1500s node Tests/playwright/exec_smoke_save.cjs
        shell: bash

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots-fixed
          path: |
            builds/screenshots/**
            dist/**
