name: Playwright Smoke Compare (fixed)

on:
  workflow_dispatch: {}
  push:
    branches: [ temp/disable-cdp, main ]

jobs:
  smoke-compare:
    name: Smoke Compare (fixed)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      PLAYWRIGHT_CONFIG: Tests/playwright/playwright.config.cjs
      ENFORCE_CLIP: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache npm
        uses: actions/cache@v4
        id: cache-npm
        with:
          path: |
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: cache-playwright
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache-node-modules
        with:
          path: |
            node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Show cache status
        run: |
          echo "cache-playwright: ${{ steps.cache-playwright.outputs.cache-hit }}"
          echo "cache-node-modules: ${{ steps.cache-node-modules.outputs.cache-hit }}"
          echo "cache-npm: ${{ steps.cache-npm.outputs.cache-hit }}"

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          npm ci
        shell: bash

      - name: Skip npm ci when node_modules cache hit
        if: steps.cache-node-modules.outputs.cache-hit == 'true'
        run: |
          echo "node_modules cache hit; skipping npm ci"

      - name: Install Playwright and browsers (only on cache miss)
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: |
          npm explore playwright -- npm i >/dev/null || true
          # install browsers and native deps only when cache miss
          npx playwright install --with-deps
        shell: bash

      - name: Install NotoJP fonts (minimal)
        run: |
          # minimal font install only (avoid large extra packages)
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends fonts-noto-cjk fonts-noto-color-emoji || true
        shell: bash

      - name: Build
        run: npm run build

      - name: Serve dist and wait
        run: |
          npx http-server dist -p 1420 -c-1 &
          npx wait-on http://localhost:1420
        shell: bash

      - name: Health check (wait up to 20s)
        run: |
          for i in 1 2 3 4; do
            if curl -fsS http://localhost:1420/ >/dev/null 2>&1; then
              echo "service ready"
              exit 0
            fi
            sleep 5
          done
          echo "Service did not become ready within 20s" >&2
          exit 1
        shell: bash

      - name: Run smoke capture
        env:
          FORCE_SYSTEM_UI: '1'
          DISABLE_CDP: '1'
          URL: 'http://localhost:1420/'
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          mkdir -p builds/screenshots
          # run with a safety timeout to avoid long-running hangs (20m)
          timeout 1200s node Tests/playwright/exec_smoke_save.cjs
        shell: bash

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots-fixed
          path: |
            builds/screenshots/**
            dist/**
