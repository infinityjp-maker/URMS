name: Playwright Smoke Compare (fixed)

on:
  workflow_dispatch: {}
  push:
    branches: [ temp/disable-cdp, main ]

jobs:
  smoke-compare:
    name: Smoke Compare (fixed)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      PLAYWRIGHT_CONFIG: Tests/playwright/playwright.config.cjs
      ENFORCE_CLIP: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright and browsers
        run: |
          npm explore playwright -- npm i >/dev/null || true
          npx playwright install --with-deps
        shell: bash

      - name: Install NotoJP fonts
        run: |
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y fonts-noto-cjk fonts-noto-color-emoji || true
        shell: bash

      - name: Build
        run: npm run build

      - name: Serve dist and wait
        run: |
          npx http-server dist -p 1420 -c-1 &
          npx wait-on http://localhost:1420
        shell: bash

      - name: Run smoke capture
        env:
          FORCE_SYSTEM_UI: '1'
          DISABLE_CDP: '1'
          URL: 'http://localhost:1420/'
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          mkdir -p builds/screenshots
          node Tests/playwright/exec_smoke_save.cjs
        shell: bash

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots-fixed
          path: |
            builds/screenshots/**
            dist/**
