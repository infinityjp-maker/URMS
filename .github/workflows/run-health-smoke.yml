name: Run Health Check and Smoke (manual)

on:
  workflow_dispatch: {}

jobs:
  run-health-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        shell: bash

      - name: Build
        run: npm run build

      - name: Map tauri.localhost to runner loopback
        run: |
          # remove any existing tauri.localhost entries and prepend a single IPv4 mapping
          sudo sed -i '/tauri.localhost/d' /etc/hosts || true
          sudo bash -lc "printf '127.0.0.1 tauri.localhost\n' | cat - /etc/hosts > /tmp/hosts && sudo mv /tmp/hosts /etc/hosts"
          echo '--- /etc/hosts entries for tauri.localhost ---'
          sudo grep -n 'tauri.localhost' /etc/hosts || true
          echo '--- getent hosts ---'
          getent hosts tauri.localhost || true
          echo '--- ping (IPv4) ---'
          ping -4 -c1 tauri.localhost || true
          echo '--- ping (IPv6) ---'
          ping -6 -c1 tauri.localhost || true
        shell: bash

      - name: Start ping server (background)
        run: |
          nohup env PORT=8765 node .github/workflows/ping-server.cjs > /tmp/ux-ping-8765.log 2>&1 &
          nohup env PORT=8877 node .github/workflows/ping-server.cjs > /tmp/ux-ping-8877.log 2>&1 &
          sleep 1
        shell: bash

      - name: Verify ping servers responding (debug)
        run: |
          echo 'curl 8765 ->'
          curl -svS http://127.0.0.1:8765/ux-ping || true
          echo 'curl 8877 ->'
          curl -svS http://127.0.0.1:8877/ux-ping || true
          echo 'tail /tmp/ux-ping-8765.log'
          sudo sed -n '1,200p' /tmp/ux-ping-8765.log || true
          echo 'tail /tmp/ux-ping-8877.log'
          sudo sed -n '1,200p' /tmp/ux-ping-8877.log || true
          echo 'listening ports (ss)'
          ss -ltnp | sed -n '1,200p' || true
        shell: bash

      - name: Wait for ping servers to return 200
        run: |
          for i in {1..20}; do
            c1=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8765/ux-ping || true)
            c2=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8877/ux-ping || true)
            if [ "$c1" = "200" ] && [ "$c2" = "200" ]; then echo "ping servers ready"; exit 0; fi
            echo "waiting for ping servers ($i) - 8765=$c1 8877=$c2"; sleep 1
          done
          echo 'ping servers did not become ready'; echo '--- /tmp/ux-ping-8765.log ---'; sudo sed -n '1,200p' /tmp/ux-ping-8765.log || true; echo '--- /tmp/ux-ping-8877.log ---'; sudo sed -n '1,200p' /tmp/ux-ping-8877.log || true; exit 1
        shell: bash

      - name: Verify dist exists
        run: |
          echo 'Checking dist directory'
          if [ ! -d "$GITHUB_WORKSPACE/dist" ]; then echo 'dist missing' && ls -la || true; exit 1; fi
          ls -la "$GITHUB_WORKSPACE/dist" | sed -n '1,80p'
        shell: bash

      - name: Start static server (background)
        run: |
          echo "Starting python static server serving $GITHUB_WORKSPACE/dist on 1420"
          nohup python3 -m http.server 1420 --bind 0.0.0.0 --directory "$GITHUB_WORKSPACE/dist" > /tmp/static.log 2>&1 &
          sleep 1
        shell: bash

      - name: Wait for static server
        run: |
          for i in {1..60}; do
            code1=$(curl -s -o /dev/null -w "%{http_code}" http://tauri.localhost:1420/ || true)
            code2=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:1420/ || true)
            if [ "$code1" = "200" ] || [ "$code2" = "200" ]; then echo "static ready"; exit 0; fi
            echo "waiting for static ($i) - codes: tauri.localhost=$code1, 127.0.0.1=$code2"; sleep 1
          done
          echo "static did not become ready"; echo "--- /tmp/static.log ---"; sudo cat /tmp/static.log || true; exit 1
        shell: bash

      - name: Debug network before browser (verbose)
        run: |
          echo '--- curl static (tauri.localhost & 127.0.0.1) ---'
          curl -svS http://tauri.localhost:1420/ || true
          curl -svS http://127.0.0.1:1420/ || true
          echo '--- curl ping servers (both hosts/ports) ---'
          curl -svS http://tauri.localhost:8765/ux-ping || true
          curl -svS http://127.0.0.1:8765/ux-ping || true
          curl -svS http://tauri.localhost:8877/ux-ping || true
          curl -svS http://127.0.0.1:8877/ux-ping || true
          echo '--- tail static & ping logs ---'
          sudo sed -n '1,200p' /tmp/static.log || true
          sudo sed -n '1,200p' /tmp/ux-ping-8765.log || true
          sudo sed -n '1,200p' /tmp/ux-ping-8877.log || true
          echo '--- listening ports (ss) ---'
          ss -ltnp || true
        shell: bash

      - name: Pre-smoke connectivity probes (Node)
        run: |
          echo 'Running pre-smoke connectivity probes';
          node .github/workflows/pre-smoke-probes.cjs || true
          echo '--- connectivity-preflight.json ---';
          sudo sed -n '1,200p' builds/diagnostics/connectivity-preflight.json || true
        shell: bash

      - name: Preflight health check (PowerShell)
        shell: bash
        env:
          URL: 'http://127.0.0.1:1420/'
        run: |
          pwsh -NoProfile -NonInteractive -File ./scripts/health-check.ps1 -Url "$URL" -Ports 8765,8877

      - name: Browser resolve debug (Playwright)
        env:
          URL: 'http://127.0.0.1:1420/'
        run: |
          echo 'Running browser resolve debug'
          node .github/workflows/browser-resolve-debug.cjs || true
          echo '--- browser-resolve.json ---'
          sudo sed -n '1,200p' builds/diagnostics/browser-resolve.json || true
        shell: bash

      - name: Browser preflight (Playwright)
        env:
          URL: 'http://127.0.0.1:1420/'
        run: |
          echo 'Running browser preflight using Playwright'
          node .github/workflows/browser-preflight.cjs || true
          echo '--- browser-preflight.json ---'
          sudo sed -n '1,200p' builds/diagnostics/browser-preflight.json || true
        shell: bash

      - name: Run smoke (save logs)
        env:
          URL: 'http://127.0.0.1:1420/'
        run: |
          mkdir -p .github/actions-runs || true
          node Tests/playwright/smoke.cjs > .github/actions-runs/last-smoke.log 2>&1 || true
          ls -la .github/actions-runs || true
        shell: bash

      - name: Parse artifacts (generate summary)
        run: |
          node scripts/parse-smoke-artifacts.cjs || true
        shell: bash

      - name: List expected artifact locations
        if: always()
        run: |
          echo '--- workspace root ---'
          ls -la "$GITHUB_WORKSPACE" | sed -n '1,200p' || true
          echo '--- .github/actions-runs ---'
          ls -la .github/actions-runs || true
          echo '--- builds/diagnostics ---'
          ls -la builds/diagnostics || true
          echo '--- screenshots ---'
          ls -la screenshots || true
          echo '--- capture disk usage ---'
          du -sh .github/actions-runs || true
          du -sh builds/diagnostics || true
          du -sh screenshots || true
        shell: bash

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts
          path: |
            .github/actions-runs/last-smoke.log
            .github/actions-runs/smoke-summary.txt
            builds/diagnostics/**
            screenshots/**
